---
title: "9.2.3 æµ‹è¯•å‰åˆå§‹åŒ–æ•°æ®åº“â€”â€”æ•°æ®åº“è¿ç§»ï¼šæµ‹è¯•æ•°æ®åº“çš„åˆå§‹åŒ–"
typora-root-url: ../../public
---

# 9.2.3 æµ‹è¯•å‰åˆå§‹åŒ–æ•°æ®åº“â€”â€”æ•°æ®åº“è¿ç§»ï¼šæµ‹è¯•æ•°æ®åº“çš„åˆå§‹åŒ–

**æµ‹è¯•æ•°æ®åº“çš„è¡¨ç»“æ„å¿…é¡»ä¸å¼€å‘/ç”Ÿäº§ä¿æŒä¸€è‡´ï¼Œè¿ç§»æ˜¯ä¿è¯è¿™ä¸€ç‚¹çš„å…³é”®ã€‚**

## æµ‹è¯•æ•°æ®åº“åˆå§‹åŒ–æµç¨‹

```mermaid
graph LR
    A[åˆ›å»ºæµ‹è¯•æ•°æ®åº“] --> B[è¿è¡Œè¿ç§»]
    B --> C[ç”Ÿæˆ Prisma Client]
    C --> D[æ‰§è¡Œæµ‹è¯•]
    D --> E[æ¸…ç†æ•°æ®]
    E --> F{è¿˜æœ‰æµ‹è¯•?}
    F -->|æ˜¯| D
    F -->|å¦| G[ç»“æŸ]
```

## ä½¿ç”¨ Prisma ç®¡ç†æµ‹è¯•æ•°æ®åº“è¿ç§»

### æ–¹æ³•ä¸€ï¼šmigrate deployï¼ˆæ¨èç”¨äº CIï¼‰

```bash
# éƒ¨ç½²å·²æœ‰çš„è¿ç§»åˆ°æµ‹è¯•æ•°æ®åº“
dotenv -e .env.test -- npx prisma migrate deploy
```

```json
// package.json
{
  "scripts": {
    "test:setup": "dotenv -e .env.test -- prisma migrate deploy",
    "test": "npm run test:setup && dotenv -e .env.test -- jest",
    "test:ci": "npm run test:setup && dotenv -e .env.test -- jest --ci"
  }
}
```

### æ–¹æ³•äºŒï¼šmigrate resetï¼ˆå¼€å‘æ—¶ä½¿ç”¨ï¼‰

```bash
# é‡ç½®æ•°æ®åº“å¹¶é‡æ–°è¿è¡Œæ‰€æœ‰è¿ç§»
dotenv -e .env.test -- npx prisma migrate reset --force
```

```json
// package.json
{
  "scripts": {
    "test:reset": "dotenv -e .env.test -- prisma migrate reset --force",
    "test:fresh": "npm run test:reset && dotenv -e .env.test -- jest"
  }
}
```

### æ–¹æ³•ä¸‰ï¼šdb pushï¼ˆå¿«é€ŸåŸå‹ï¼‰

```bash
# ç›´æ¥æ¨é€ schema å˜æ›´ï¼ˆä¸ç”Ÿæˆè¿ç§»æ–‡ä»¶ï¼‰
dotenv -e .env.test -- npx prisma db push
```

## è‡ªåŠ¨åŒ–æµ‹è¯•æ•°æ®åº“åˆå§‹åŒ–

```typescript
// test/setup-db.ts
import { execSync } from 'child_process';
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

export async function setupTestDatabase() {
  console.log('ğŸ”§ Setting up test database...');
  
  try {
    // è¿è¡Œè¿ç§»
    execSync('npx prisma migrate deploy', {
      env: { ...process.env, DATABASE_URL: process.env.DATABASE_URL },
      stdio: 'inherit',
    });
    
    // éªŒè¯è¿æ¥
    await prisma.$connect();
    console.log('âœ… Test database ready');
  } catch (error) {
    console.error('âŒ Failed to setup test database:', error);
    throw error;
  }
}

export async function teardownTestDatabase() {
  await prisma.$disconnect();
}
```

```typescript
// jest.setup.ts
import { setupTestDatabase, teardownTestDatabase } from './test/setup-db';

beforeAll(async () => {
  await setupTestDatabase();
});

afterAll(async () => {
  await teardownTestDatabase();
});
```

## Jest å…¨å±€é…ç½®

```typescript
// jest.config.ts
import type { Config } from 'jest';

const config: Config = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  setupFilesAfterEnv: ['<rootDir>/jest.setup.ts'],
  globalSetup: '<rootDir>/test/global-setup.ts',
  globalTeardown: '<rootDir>/test/global-teardown.ts',
  testTimeout: 30000, // è¿ç§»å¯èƒ½éœ€è¦è¾ƒé•¿æ—¶é—´
};

export default config;
```

```typescript
// test/global-setup.ts
import { execSync } from 'child_process';

export default async function globalSetup() {
  console.log('\nğŸš€ Global test setup...');
  
  // ç¡®ä¿æµ‹è¯•æ•°æ®åº“ç»“æ„æ˜¯æœ€æ–°çš„
  execSync('dotenv -e .env.test -- npx prisma migrate deploy', {
    stdio: 'inherit',
  });
  
  // ç”Ÿæˆ Prisma Client
  execSync('npx prisma generate', { stdio: 'inherit' });
}
```

```typescript
// test/global-teardown.ts
export default async function globalTeardown() {
  console.log('\nğŸ§¹ Global test teardown...');
  // å¯é€‰ï¼šæ¸…ç†æµ‹è¯•æ•°æ®åº“
}
```

## å¤„ç†è¿ç§»å†²çª

### åœºæ™¯ï¼šæœ¬åœ°è¿ç§»ä¸è¿œç¨‹ä¸ä¸€è‡´

```bash
# æŸ¥çœ‹è¿ç§»çŠ¶æ€
dotenv -e .env.test -- npx prisma migrate status

# å¦‚æœæœ‰é—®é¢˜ï¼Œé‡ç½®æµ‹è¯•æ•°æ®åº“
dotenv -e .env.test -- npx prisma migrate reset --force
```

### åœºæ™¯ï¼šCI ä¸­è¿ç§»å¤±è´¥

```yaml
# .github/workflows/test.yml
jobs:
  test:
    steps:
      - name: Setup Database
        run: |
          # ç­‰å¾…æ•°æ®åº“å°±ç»ª
          sleep 5
          # è¿è¡Œè¿ç§»
          npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
```

## ä½¿ç”¨ Docker å®ç°ä¸€æ¬¡æ€§æ•°æ®åº“

```typescript
// test/docker-db.ts
import { execSync } from 'child_process';
import { v4 as uuid } from 'uuid';

export function createTestDatabase() {
  const dbName = `test_${uuid().replace(/-/g, '_')}`;
  
  execSync(`docker run -d --name ${dbName} \
    -e POSTGRES_DB=${dbName} \
    -e POSTGRES_USER=test \
    -e POSTGRES_PASSWORD=test \
    -p 0:5432 \
    postgres:15-alpine`);
  
  // è·å–æ˜ å°„çš„ç«¯å£
  const port = execSync(`docker port ${dbName} 5432`).toString().split(':')[1].trim();
  
  return {
    url: `postgresql://test:test@localhost:${port}/${dbName}`,
    cleanup: () => execSync(`docker rm -f ${dbName}`),
  };
}
```

## è¿ç§»ç­–ç•¥å¯¹æ¯”

| ç­–ç•¥ | é€‚ç”¨åœºæ™¯ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|---------|------|------|
| migrate deploy | CI/CD | å¿«é€Ÿã€å¯é  | éœ€è¦å·²æœ‰è¿ç§» |
| migrate reset | å¼€å‘æµ‹è¯• | å®Œå…¨é‡ç½® | è¾ƒæ…¢ |
| db push | å¿«é€ŸåŸå‹ | æœ€å¿« | å¯èƒ½ä¸¢å¤±æ•°æ® |
| Docker ä¸€æ¬¡æ€§ | å¹¶è¡Œæµ‹è¯• | å®Œå…¨éš”ç¦» | å¯åŠ¨è¾ƒæ…¢ |

## å¸¸è§é—®é¢˜

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| è¿ç§»è¶…æ—¶ | æ•°æ®åº“è¿æ¥æ…¢ | å¢åŠ è¶…æ—¶æ—¶é—´ |
| è¡¨ä¸å­˜åœ¨ | è¿ç§»æœªè¿è¡Œ | æ£€æŸ¥ migrate deploy |
| ç±»å‹ä¸åŒ¹é… | Client æœªæ›´æ–° | è¿è¡Œ prisma generate |
| å¹¶è¡Œå†²çª | å…±äº«æ•°æ®åº“ | ä½¿ç”¨äº‹åŠ¡æˆ– Docker |

## æœ¬èŠ‚å°ç»“

æµ‹è¯•æ•°æ®åº“è¿ç§»çš„æ ¸å¿ƒç›®æ ‡æ˜¯**ç¡®ä¿æµ‹è¯•ç¯å¢ƒçš„è¡¨ç»“æ„ä¸ç”Ÿäº§ä¸€è‡´**ã€‚æ¨èåœ¨ CI ä¸­ä½¿ç”¨ `migrate deploy`ï¼Œåœ¨æœ¬åœ°å¼€å‘æ—¶ä½¿ç”¨ `migrate reset`ã€‚é€šè¿‡ Jest çš„å…¨å±€é…ç½®ï¼Œå¯ä»¥åœ¨æµ‹è¯•è¿è¡Œå‰è‡ªåŠ¨å®Œæˆè¿ç§»ï¼Œè®©æµ‹è¯•ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘éªŒè¯ã€‚
