---
title: "10.5.3 ä¸€å‡ºé”™å°±é€šçŸ¥æˆ‘â€”â€”é”™è¯¯è¿½è¸ªï¼šå¼‚å¸¸æ•è·ä¸å‘Šè­¦æœºåˆ¶"
typora-root-url: ../../public
---

# 10.5.3 ä¸€å‡ºé”™å°±é€šçŸ¥æˆ‘â€”â€”é”™è¯¯è¿½è¸ªï¼šå¼‚å¸¸æ•è·ä¸å‘Šè­¦æœºåˆ¶

é”™è¯¯å‘ç”Ÿäº†ä¸å¯æ€•ï¼Œå¯æ€•çš„æ˜¯ä½ ä¸çŸ¥é“ã€‚

## é”™è¯¯è¿½è¸ª vs æ—¥å¿—

| å¯¹æ¯”é¡¹ | æ—¥å¿— | é”™è¯¯è¿½è¸ª |
|--------|------|----------|
| ä¿¡æ¯é‡ | ä¸€è¡Œæ–‡æœ¬ | å®Œæ•´ä¸Šä¸‹æ–‡ |
| å †æ ˆ | å¯èƒ½æœ‰ | å®Œæ•´å †æ ˆ |
| èšåˆ | æ—  | ç›¸åŒé”™è¯¯è‡ªåŠ¨èšåˆ |
| é€šçŸ¥ | éœ€è¦é¢å¤–é…ç½® | å†…ç½®å‘Šè­¦ |
| ç”¨æˆ·ä¿¡æ¯ | æ‰‹åŠ¨è®°å½• | è‡ªåŠ¨å…³è” |

## Sentry é›†æˆ

Sentry æ˜¯æœ€æµè¡Œçš„é”™è¯¯è¿½è¸ªæœåŠ¡ï¼Œå…è´¹ç‰ˆå¤Ÿç”¨ã€‚

### åç«¯é›†æˆï¼ˆNestJSï¼‰

```bash
npm install @sentry/node
```

```typescript
// main.ts
import * as Sentry from '@sentry/node';

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1,  // é‡‡æ · 10% çš„è¯·æ±‚
});

// å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
@Catch()
export class SentryExceptionFilter implements ExceptionFilter {
  catch(exception: any, host: ArgumentsHost) {
    Sentry.captureException(exception);
    
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    
    response.status(500).json({
      message: 'Internal server error',
    });
  }
}
```

### å‰ç«¯é›†æˆï¼ˆNext.jsï¼‰

```bash
npm install @sentry/nextjs
npx @sentry/wizard@latest -i nextjs
```

```typescript
// sentry.client.config.ts
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: 0.1,
});
```

### æ•è·è‡ªå®šä¹‰é”™è¯¯

```typescript
try {
  await processPayment(order);
} catch (error) {
  Sentry.captureException(error, {
    extra: {
      orderId: order.id,
      amount: order.total,
    },
    tags: {
      payment_gateway: 'stripe',
    },
    user: {
      id: user.id,
      email: user.email,
    },
  });
  throw error;
}
```

## å‘Šè­¦é…ç½®

### å‘Šè­¦æ¸ é“

| æ¸ é“ | ä¼˜ç‚¹ | ç¼ºç‚¹ |
|------|------|------|
| é‚®ä»¶ | è¯¦ç»†ã€å¯è¿½æº¯ | å®¹æ˜“è¢«å¿½ç•¥ |
| é’‰é’‰/é£ä¹¦ | å³æ—¶ã€å›¢é˜Ÿå¯è§ | å¯èƒ½æ‰“æ‰° |
| çŸ­ä¿¡ | ç´§æ€¥é€šçŸ¥ | æˆæœ¬é«˜ |
| ç”µè¯ | æœ€ç´§æ€¥ | æˆæœ¬æœ€é«˜ |

### é’‰é’‰æœºå™¨äººå‘Šè­¦

```typescript
async function sendDingTalkAlert(message: string) {
  const webhook = process.env.DINGTALK_WEBHOOK;
  
  await fetch(webhook, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      msgtype: 'markdown',
      markdown: {
        title: 'æœåŠ¡å‘Šè­¦',
        text: `## æœåŠ¡å‘Šè­¦\n\n${message}\n\næ—¶é—´ï¼š${new Date().toLocaleString()}`,
      },
    }),
  });
}
```

### é£ä¹¦æœºå™¨äººå‘Šè­¦

```typescript
async function sendFeishuAlert(title: string, content: string) {
  const webhook = process.env.FEISHU_WEBHOOK;
  
  await fetch(webhook, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      msg_type: 'interactive',
      card: {
        header: {
          title: { content: title, tag: 'plain_text' },
          template: 'red',
        },
        elements: [{
          tag: 'div',
          text: { content, tag: 'plain_text' },
        }],
      },
    }),
  });
}
```

## å‘Šè­¦è§„åˆ™è®¾è®¡

### åˆ†çº§å‘Šè­¦

```mermaid
flowchart TB
    A[é”™è¯¯å‘ç”Ÿ] --> B{é”™è¯¯çº§åˆ«?}
    B -->|P0 ç´§æ€¥| C[ç”µè¯ + çŸ­ä¿¡ + ç¾¤æ¶ˆæ¯]
    B -->|P1 é‡è¦| D[çŸ­ä¿¡ + ç¾¤æ¶ˆæ¯]
    B -->|P2 ä¸€èˆ¬| E[ç¾¤æ¶ˆæ¯]
    B -->|P3 ä½ä¼˜| F[é‚®ä»¶]
```

| çº§åˆ« | å®šä¹‰ | å“åº”æ—¶é—´ |
|------|------|----------|
| P0 | æœåŠ¡å®Œå…¨ä¸å¯ç”¨ | 5 åˆ†é’Ÿ |
| P1 | æ ¸å¿ƒåŠŸèƒ½å—æŸ | 30 åˆ†é’Ÿ |
| P2 | éæ ¸å¿ƒåŠŸèƒ½é—®é¢˜ | 4 å°æ—¶ |
| P3 | ç”¨æˆ·å¯æ¥å—çš„é—®é¢˜ | 1 å¤© |

### é¿å…å‘Šè­¦ç–²åŠ³

```typescript
// é”™è¯¯èšåˆ - ç›¸åŒé”™è¯¯ 5 åˆ†é’Ÿå†…åªå‘Šè­¦ä¸€æ¬¡
const alertCache = new Map<string, number>();

function shouldAlert(errorKey: string): boolean {
  const lastAlert = alertCache.get(errorKey);
  const now = Date.now();
  
  if (lastAlert && now - lastAlert < 5 * 60 * 1000) {
    return false;
  }
  
  alertCache.set(errorKey, now);
  return true;
}
```

## UptimeRobot å‘Šè­¦

### é…ç½®å‘Šè­¦è”ç³»äºº

1. è®¾ç½® â†’ Alert Contacts
2. æ·»åŠ è”ç³»æ–¹å¼ï¼š
   - Email
   - Webhookï¼ˆæ¨èï¼Œå¯é›†æˆé’‰é’‰/é£ä¹¦ï¼‰
   - Slack/Discord

### Webhook è½¬å‘åˆ°é’‰é’‰

```javascript
// æ¥æ”¶ UptimeRobot webhookï¼Œè½¬å‘åˆ°é’‰é’‰
app.post('/webhook/uptime', async (req, res) => {
  const { monitorFriendlyName, alertType, alertDetails } = req.body;
  
  const isDown = alertType === '1';
  const message = isDown 
    ? `ğŸ”´ æœåŠ¡å®•æœºï¼š${monitorFriendlyName}\n${alertDetails}`
    : `ğŸŸ¢ æœåŠ¡æ¢å¤ï¼š${monitorFriendlyName}`;
  
  await sendDingTalkAlert(message);
  res.send('ok');
});
```

## é”™è¯¯å¤„ç†æœ€ä½³å®è·µ

### å…¨å±€å¼‚å¸¸å¤„ç†

```typescript
// NestJS å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨
@Catch()
export class GlobalExceptionFilter implements ExceptionFilter {
  catch(exception: any, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse();
    const request = ctx.getRequest();
    
    // è®°å½•é”™è¯¯
    console.error(JSON.stringify({
      level: 'error',
      message: exception.message,
      stack: exception.stack,
      path: request.url,
      method: request.method,
      userId: request.user?.id,
    }));
    
    // å‘é€åˆ° Sentry
    Sentry.captureException(exception);
    
    // è¿”å›ç”¨æˆ·å‹å¥½çš„é”™è¯¯
    response.status(500).json({
      statusCode: 500,
      message: 'Something went wrong',
    });
  }
}
```

### ä¸è¦æš´éœ²æ•æ„Ÿä¿¡æ¯

```typescript
// é”™è¯¯çš„åšæ³•
res.status(500).json({ error: exception.message }); // å¯èƒ½æ³„éœ²æ•°æ®åº“ä¿¡æ¯

// æ­£ç¡®çš„åšæ³•
res.status(500).json({ message: 'Internal server error' });
```

## å¸¸è§é—®é¢˜

| é—®é¢˜ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|------|----------|
| å‘Šè­¦å¤ªå¤š | é˜ˆå€¼å¤ªæ•æ„Ÿ | è°ƒæ•´é˜ˆå€¼ï¼Œé”™è¯¯èšåˆ |
| å‘Šè­¦å¤ªå°‘ | é”™è¯¯æœªæ•è· | å®Œå–„å…¨å±€å¼‚å¸¸å¤„ç† |
| å‘Šè­¦å»¶è¿Ÿ | æ£€æŸ¥é—´éš”å¤ªé•¿ | ç¼©çŸ­æ£€æŸ¥é—´éš” |
| é‡å¤å‘Šè­¦ | æœªåšå»é‡ | æ·»åŠ å‘Šè­¦èšåˆé€»è¾‘ |
